name: Main Branch Workflow

on:
    push:
      branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
        - uses: actions/setup-java@v1
          with:
                java-version: 1.8
        - name: Cache Maven packages
          uses: actions/cache@v2
          with:
                path: ~/.m2
                key: ${{runner.os}}-m2-${{hashFiles('**/pom.xml')}}
        - name: Build with Maven
          run: mvn clean package

        - uses: actions/upload-artifact@v1
          with:
            name: verademo.war
            path: target/verademo.war

    policy-scan:
        runs-on: ubuntu-latest
        needs: build
        steps:
        - uses: actions/checkout@v2
        - name: get archive
          uses: action/download-artifact@v2
          with:
            name: verademo.war
            path: .
        - name: Veracdoe Upload and Scan Action Step
          uses : veracode/veracode-uploadscan-action@master
          id: upload_and_scan
          with:
                appname: "Verademo GitHub Training"
                createprofile: true
                version: '${{github.run_id}}'
                filepath: 'verademo.war'
                vid: 'e20ba9508201f789b667fafd1a00184b'
                vkey: '5f8f7b331b7128f67b01fa153cf340d2debcd30aa0cf1a72aefd68ade7567e0382586842e28672b3d441ed99d2351c2ee18f18d69668a917'
                scantimeout: 15

